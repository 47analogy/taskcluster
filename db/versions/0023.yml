version: 23
migrationScript: 0023-migration.sql
downgradeScript: 0023-downgrade.sql
methods:
  taskcluster_github_builds_entities_load:
    description: See taskcluster-lib-entities
    mode: read
    serviceName: github
    args: partition_key text, row_key text
    returns: table (partition_key_out text, row_key_out text, value jsonb, version integer, etag uuid)
    body: |-
      begin
       return query
       select
          taskcluster_github_builds_entities_load.partition_key,
          'taskGroupId' as row_key,
          jsonb_build_object(
            'PartitionKey', taskcluster_github_builds_entities_load.partition_key,
            'RowKey', 'taskGroupId',
            'organization', organization,
            'repository', repository,
            'sha', sha,
            'taskGroupId', task_group_id,
            'state', state,
            'created', created,
            'updated', updated,
            'installationId', installation_id,
            'eventType', event_type,
            'eventId', event_id) as value,
          1 as version,
          github_builds.etag as etag
      from github_builds
      where
        github_builds.task_group_id = decode_string_key(taskcluster_github_builds_entities_load.partition_key);
      end
  taskcluster_github_builds_entities_create:
    description: See taskcluster-lib-entities
    serviceName: github
    mode: write
    args: pk text, rk text, properties jsonb, overwrite boolean, version integer
    returns: uuid
    body: |-
      declare
        new_row github_builds%ROWTYPE;
      begin
        select
          (properties ->> 'organization')::text as organization,
          (properties ->> 'repository')::text as repository,
          (properties ->> 'sha')::text as sha,
          (properties ->> 'taskGroupId')::text as task_group_id,
          (properties ->> 'state')::text as state,
          (properties ->> 'created')::timestamptz as created,
          (properties ->> 'updated')::timestamptz as updated,
          (properties ->> 'installationId')::integer as installation_id,
          (properties ->> 'eventType')::text as event_type,
          (properties ->> 'eventId')::text as event_id,
          public.gen_random_uuid() as etag
        into new_row;
        if overwrite then
          raise exception 'overwrite not implemented';
        else
          execute 'insert into github_builds select $1.*' using new_row;
        end if;
        return new_row.etag;
      end
  taskcluster_github_builds_entities_scan:
    description: See taskcluster-lib-entities
    mode: read
    serviceName: github
    args: pk text, rk text, condition text, size integer, page integer
    returns: table (partition_key text, row_key text, value jsonb, version integer, etag uuid)
    body: |-
      declare
      begin
        if not condition is null then
          raise exception 'condition not supported';
        end if;
        return query
          select
            taskcluster_github_builds_entities_scan.partition_key,
            'taskGroupId' as row_key,
            jsonb_build_object(
              'PartitionKey', encode_string_key(task_group_id),
              'RowKey', 'taskGroupId',
              'organization', organization,
              'repository', repository,
              'sha', sha,
              'taskGroupId', task_group_id,
              'state', state,
              'created', created,
              'updated', updated,
              'installationId', installation_id,
              'eventType', event_type,
              'eventId', event_id) as value,
              1 as version,
          github_builds.etag as etag
          from github_builds
          where
            partition_key is null or
            task_group_id = decode_string_key(task_group_id)
          order by task_group_id
          limit size + 1
          offset page;
      end
  taskcluster_github_builds_entities_remove:
    serviceName: github
    description: See taskcluster-lib-entities
    mode: write
    args: partition_key text, row_key text
    returns: table (etag uuid)
    body: |-
      begin
        delete
        from github_builds
        where
          github_builds.task_group_id = decode_string_key(partition_key);
        -- tc-gh does not care if the row existed
        return query select gen_random_uuid() as etag;
      end
  taskcluster_github_builds_entities_modify:
    serviceName: github
    description: See taskcluster-lib-entities
    mode: write
    args: partition_key text, row_key text, properties jsonb, version integer, old_etag uuid
    returns: table (etag uuid)
    body: |-
      declare
        new_row github_builds%ROWTYPE;
      begin
        select
          (properties ->> 'organization')::text as organization,
          (properties ->> 'repository')::text as repository,
          (properties ->> 'sha')::text as sha,
          (properties ->> 'taskGroupId')::text as task_group_id,
          (properties ->> 'state')::text as state,
          (properties ->> 'created')::timestamptz as created,
          (properties ->> 'updated')::timestamptz as updated,
          (properties ->> 'installationId')::integer as installation_id,
          (properties ->> 'eventType')::text as event_type,
          (properties ->> 'eventId')::text as event_id,
          public.gen_random_uuid() as etag
        into new_row;
        update github_builds
        set (
          organization,
          repository,
          sha,
          task_group_id,
          state,
          created,
          updated,
          installation_id,
          event_type,
          event_id,
          etag
        ) = (
          new_row.organization,
          new_row.repository,
          new_row.sha,
          new_row.task_group_id,
          new_row.state,
          new_row.created,
          new_row.updated,
          new_row.installation_id,
          new_row.event_type,
          new_row.event_id,
          new_row.etag
        )
        where
          github_builds.task_group_id = decode_string_key(taskcluster_github_builds_entities_modify.partition_key) and
          github_builds.etag = taskcluster_github_builds_entities_modify.old_etag;

        if found then
          return query select new_row.etag;
          return;
        end if;

        perform github_builds.etag from github_builds
        where github_builds.task_group_id = decode_string_key(taskcluster_github_builds_entities_modify.partition_key);

        if found then
          raise exception 'unsuccessful update' using errcode = 'P0004';
        else
          raise exception 'no such row' using errcode = 'P0002';
        end if;
      end